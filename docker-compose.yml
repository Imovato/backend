version: '3.4'
services:

  ######################### DATABASES #########################

  discovery:
    image: matt0balda/discovery:0.0.1-SNAPSHOT
    ports:
      - 8087:8087
    networks:
      - imovato-network

  gateway:
    image: matt0balda/gateway:0.0.1-SNAPSHOT
    ports:
      - 8080:8080
    depends_on:
      - discovery
    environment:
      EUREKA.CLIENT.SERVICEURL.DEFAULTZONE: http://discovery:8087/discovery
    networks:
      - imovato-network

  crudservice:
    image: matt0balda/imovato:crudservice
    ports:
      - 8081:8081
    depends_on:
      - discovery
      - gateway
      - database
      - rabbitmq
    networks:
      - networkApp
  
  database:
    image: postgres
    ports: 
      - 5432:5432
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=root
      - POSTGRES_DB=my_db
      - PGDATA=/data/postgres
    volumes: 
      - ./postgres:/data/postgres
    restart: unless-stopped
    
    networks:
      - networkApp
  
  pgadmin:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL= admin
      - PGADMIN_DEFAULT_PASSWORD= root
    volumes:
      - ./docker_pgadmin_servers.json:/pgadmin4/servers.json
    ports:
      - "16543:80"
    restart: unless-stopped
    depends_on:
      - database
    networks:
      - networkApp

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - 5672:5672
      - 15672:15672
    volumes:
      - ./rabbit_definitions.json:/etc/rabbitmq/rabbit_definitions.json
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./storage/rabbitmq1:/var/lib/rabbitmq
    working_dir: /var/lib/rabbitmq
    environment: 
      - RABBITMQ_ERLANG_COOKIE=secret_pass
      #- RABBITMQ_DEFAULT_USER=admin
      #- RABBITMQ_DEFAULT_PASS=admin
      #- RABBITMQ_LOAD_DEFINITIONS=./rabbit_definitions.json
    networks:
      - networkApp

volumes:
  #database:
  rabbitmq:

networks:
  imovato-network:
    driver: bridge